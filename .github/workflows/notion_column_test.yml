name: Notion Column Debug

on:
  workflow_dispatch:

jobs:
  test-columns:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install notion-client

      - name: Create test script
        run: |
          printf "%s\n" \
"import os" \
"from notion_client import Client" \
"" \
"notion = Client(auth=os.getenv('NOTION_TOKEN'))" \
"page_id = os.getenv('TEST_PAGE_ID')" \
"" \
"print('\\nðŸ” Fetching level 1 blocksâ€¦')" \
"level1 = notion.blocks.children.list(page_id)" \
"print('LEVEL 1 TYPES:', [b['type'] for b in level1['results']])" \
"" \
"col_list_id = None" \
"for b in level1['results']:" \
"    if b['type'] == 'column_list':" \
"        col_list_id = b['id']" \
"        break" \
"" \
"print('\\ncolumn_list id:', col_list_id)" \
"" \
"if not col_list_id:" \
"    print('âŒ No column_list found on this page')" \
"    exit()" \
"" \
"print('\\nðŸ” Fetching columns inside column_listâ€¦')" \
"cols = notion.blocks.children.list(col_list_id)" \
"print('COLUMNS:', [c['id'] for c in cols['results']])" \
"" \
"for col in cols['results']:" \
"    cid = col['id']" \
"    print(f'\\nðŸ” Fetching children of column {cid} â€¦')" \
"    children = notion.blocks.children.list(cid)" \
"    types = [ch['type'] for ch in children['results']]" \
"    print('CHILD TYPES:', types)" \
"" \
"    for ch in children['results']:" \
"        data = ch.get(ch['type'], {})" \
"        rt = data.get('rich_text')" \
"        if rt:" \
"            text = [t.get('plain_text', '') for t in rt]" \
"            print(' â€¢', ch['type'], 'â†’', text)" \
"        else:" \
"            print(' â€¢', ch['type'], '(no rich_text)')" \
> test_columns.py

      - name: Run test
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          TEST_PAGE_ID: ${{ secrets.TEST_PAGE_ID }}
        run: |
          python test_columns.py
